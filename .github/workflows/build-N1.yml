name: Build OpenWrt LEAN for Phicomm N1

on:
    workflow_dispatch:

env:
    REPO_URL: https://github.com/coolsnowwolf/lede
    REPO_BRANCH: master
    CONFIG_FILE: N1-LEDE/.config
    DIY_SH: N1-LEDE/diy.sh
    FILES: N1-LEDE/files
    TZ: Asia/Shanghai

jobs:
    build:
        runs-on: ubuntu-22.04

        steps:
            # ============================
            # 1. 显示 Runner 基本硬件信息（仅用于参考）
            # ============================
            - name: Show runner hardware info
              run: |
                  echo "========== CPU =========="
                  cat /proc/cpuinfo | grep name | uniq -c
                  echo "========== Memory =========="
                  free -h
                  echo "========== Disk =========="
                  df -hT

            # ============================
            # 2. 清理磁盘空间（安全方案）
            # ============================
            - name: Optimize disk space
              uses: hugoalh/disk-space-optimizer-ghaction@v0.8.1
              with:
                  operate_sudo: "True"
                  general_include: ".+"
                  docker_prune: "True"
                  docker_clean: "True"
                  apt_prune: "True"
                  apt_clean: "True"
                  npm_prune: "True"
                  npm_clean: "True"
                  os_swap: "True"

            - name: Disk space after cleanup
              run: df -hT

            # ============================
            # 3. 拉取当前仓库（你的 .config / diy.sh）
            # ============================
            - name: Checkout repository
              uses: actions/checkout@v4

            # ============================
            # 4. 初始化编译环境
            # ============================
            - name: Initialize build environment
              env:
                  DEBIAN_FRONTEND: noninteractive
              run: |
                  sudo apt update
                  sudo apt install -y \
                    build-essential clang flex bison g++ gawk gcc-multilib \
                    gettext git libncurses-dev libssl-dev python3 python3-distutils \
                    rsync unzip zlib1g-dev file wget curl time rename
                  sudo apt autoremove -y --purge
                  sudo apt clean
                  sudo timedatectl set-timezone "$TZ"
                  sudo chown -R $USER:$GROUPS $GITHUB_WORKSPACE

            # ============================
            # 5. 克隆 Lean OpenWrt 源码
            # ============================
            - name: Clone OpenWrt source
              run: |
                  git clone $REPO_URL -b $REPO_BRANCH openwrt

            # ============================
            # 6. 更新并安装 feeds
            # ============================
            - name: Update & install feeds
              working-directory: openwrt
              run: |
                  ./scripts/feeds update -a
                  ./scripts/feeds install -a

            # ============================
            # 7. 加载自定义配置和 DIY 脚本
            # ============================
            - name: Load custom configuration
              run: |
                  [ -e $FILES ] && mv $FILES openwrt/files
                  [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
                  chmod +x $DIY_SH
                  cd openwrt
                  $GITHUB_WORKSPACE/$DIY_SH

            # ============================
            # 8. 下载编译依赖源码包
            # ============================
            - name: Download packages
              working-directory: openwrt
              run: |
                  make defconfig
                  make download -j$(nproc)
                  find dl -size -1024c -delete

            # ============================
            # 9. 编译 OpenWrt
            # ============================
            - name: Compile OpenWrt
              run: |
                  chmod -R 755 openwrt
                  cd openwrt
                  echo "Using $(nproc) threads"
                  make -j$(nproc) || make -j1 || make -j1 V=s
                  echo "compile_status=success" >> $GITHUB_ENV

            # ============================
            # 10. 打包 N1（Amlogic s905d）固件
            # ============================
            - name: Package firmware for N1
              if: env.compile_status == 'success'
              uses: unifreq/openwrt_packit@master
              env:
                  OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/openwrt-amlogic-mesongx-phicomm_n1-rootfs.tar.gz
                  KERNEL_VERSION_NAME: 5.15.196
                  KERNEL_AUTO_LATEST: false
                  PACKAGE_SOC: s905d
                  WHOAMI: fightroad
                  SW_FLOWOFFLOAD: 1
                  SFE_FLOW: 0

            # ============================
            # 11. 发布到 GitHub Release
            # ============================
            - name: Upload firmware to Release
              if: env.PACKAGED_STATUS == 'success'
              uses: ncipollo/release-action@v1
              with:
                  tag: OpenWrt_N1_${{ env.PACKAGED_OUTPUTDATE }}
                  artifacts: /opt/openwrt_packit/output/*
                  allowUpdates: true
                  token: ${{ secrets.GITHUB_TOKEN }}
                  body: |
                      基于 Lean OpenWrt 构建（斐讯 N1）

                      默认信息：
                      IP：192.168.123.1
                      用户名：root
                      密码：password

                      已启用：
                      - USB 共享网络（支持安卓 / iOS）
                      - Flow Offload

            # ============================
            # 12. 清理旧 Release
            # ============================
            - name: Delete old releases
              uses: dev-drprasad/delete-older-releases@master
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  keep_latest: 10
                  delete_tags: true
